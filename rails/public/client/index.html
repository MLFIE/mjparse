<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>Mj-Tsumotter</title>
    <!--
    <script type="text/javascript" charset="utf-8" src="phonegap.0.9.5.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="photo.js"></script>
    -->

    <link rel="stylesheet" type="text/css" href="pc/top.css">

    </style>

    <script type="text/javascript" charset="utf-8" src="pc/photo.js"></script>
    <script type="text/javascript" charset="utf-8" src="util.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery-1.6.1.min.js"></script>
    <script type="text/javascript" charset="utf-8" >
      function sendPhoto() {
        console.log("start sendding photo...");
        infomsg("start sendding photo...")

        var url = "/agaris";
        var request = createXMLHttpRequest();

        //フォームからパラメータ作成
        var param = {
          agari: {}
        };

        $("input:text").each( function() {
          var name = $(this).attr("name");
          param["agari"][name] = $(this).val();
        });
        $("select").each( function() {
          var name = $(this).attr("name");
          var val = $(this).children(":selected").attr("value")
          if(val.match(/^[0-9]+$/)) {
            val = parseInt(val);
          }
          param["agari"][name] = val;
        });
        $("input:checkbox").each( function() {
          var name = $(this).attr("name");
          var val = $(this).attr("checked")=="checked";
          param["agari"][name] = val;
        });
        //dbgmsg(print_r(param));

        //is_parentの計算
        param["agari"]["is_parent"] = param["agari"]["jikaze"]=="ton";

        //JSONに変換
        var json = toJSON(param);
        dbgmsg(json);

        //リクエスト送信
        var httpObj = createXMLHttpRequest();

        httpObj.open("POST", url, false);
        httpObj.setRequestHeader("Content-Type","application/json");
        httpObj.send(json);
        if(httpObj.status == "200") {
          console.log("success to send");
          infomsg("success to send");
        } else {
          console.log("!!! fail to send !!!  error code:" + httpObj.status  );
          infomsg("!!! fail to send !!!  error code:" + httpObj.status );
          dbgmsg(httpObj.responseText);
        }
      }

      function infomsg(msg) {
        // 画像表示
        var image = document.getElementById('infolabel');
        image.innerHTML = msg;
      }

      function dbgmsg(msg) {
        // 画像表示
        var image = document.getElementById('dbglabel');
        image.innerHTML += msg + "<br>";
      }
    </script>
  </head>

  <body onload="onLoad()">
    <h1>Mj-Tsumotter</h1>
    <p>
      <label type="text" style="font-size:120%" id="infolabel">
        let's take mj agari photo
      </label>
    </p>
    <p>
      <button onclick="capturePhoto();">
        Capture Photo
      </button>
    </p>
    <p>
      <button onclick="selectPhoto();">
        Select Photo
      </button>
    </p>
    <p>
      <button onclick="sendPhoto();">
        Send Photo
      </button>
    </p>
    <img name="image" style="display:none;width:300px" id="image" src="" />

    <form name="agari">
      <div>
        画像URL
        <input id="img_url" type="text" name="img_url">
      </div>
      <div>
        場風
        <select name="bakaze">
          <option value="ton">東</option>
          <option value="nan">南</option>
          <option value="sha">西</option>
          <option value="pei">北</option>
        </select>
      </div>
      <div>
        自風
        <select name="jikaze">
          <option value="ton">東</option>
          <option value="nan">南</option>
          <option value="sha">西</option>
          <option value="pei">北</option>
        </select>
      </div>
      <div>
        本場
        <select name="honba_num">
          <script type="text/javascript" charset="utf-8">
            for(i=0;i<10;i++) {
              document.write("<option value=" + i + ">" + i + " </option>");
            }
          </script>
        </select>
      </div>
      <div>
        アガリ種類
        <select name="is_tsumo">
          <option value="true">ツモ</option>
          <option value="false">ロン</option>
        </select>
      </div>
      <div>
        ドラ数
        <select name="dora_num">
          <script type="text/javascript" charset="utf-8">
            for(i=0;i<30;i++) {
              document.write("<option value=" + i + ">" + i + " </option>");
            }
          </script>
        </select>
      </div>
      <div>
        リーチ
        <select name="reach_num">
          <option value="0">なし</option>
          <option value="1">ノーマル</option>
          <option value="2">ダブリー</option>
        </select>
      </div>
      <div>
        一発
        <input type="checkbox" name="is_ippatsu" value="true">
      </div>
      <div>
        海底
        <input type="checkbox" name="is_haitei" value="true">
      </div>
      <div>
        嶺上開花
        <input type="checkbox" name="is_rinshan" value="true">
      </div>
      <div>
        槍槓
        <input type="checkbox" name="is_chankan" value="true">
      </div>
      <div>
        天和
        <input type="checkbox" name="is_tenho" value="true">
      </div>
      <div>
        地和
        <input type="checkbox" name="is_chiho" value="true">
      </div>
    </form>

    <p>
      <label type="text" id="dbglabel">
        ---------- debug message ----------
        <br>
      </label>
    </p>

  </body>

</html>

