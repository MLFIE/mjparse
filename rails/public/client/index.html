<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>Mj-Tsumotter</title>
    <!--
    <script type="text/javascript" charset="utf-8" src="phonegap.0.9.5.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="photo.js"></script>
    -->

    <link rel="stylesheet" type="text/css" href="pc/top.css">

    </style>

    <script type="text/javascript" charset="utf-8" src="pc/photo.js"></script>
    <script type="text/javascript" charset="utf-8" src="util.js"></script>
    <script type="text/javascript" charset="utf-8" src="jquery-1.6.1.min.js"></script>
    <script type="text/javascript" charset="utf-8" >
      function sendPhoto() {
        infomsg("start sendding photo...")

        var url = "/agaris.json";

        //フォームからパラメータ作成
        var param = {
          agari: {}
        };

        $("input:text").each( function() {
          var name = $(this).attr("name");
          param["agari"][name] = $(this).val();
        });
        $("select").each( function() {
          var name = $(this).attr("name");
          var val = $(this).children(":selected").attr("value")
          if(val.match(/^[0-9]+$/)) {
            val = parseInt(val);
          }
          param["agari"][name] = val;
        });
        $("input:checkbox").each( function() {
          var name = $(this).attr("name");
          var val = $(this).attr("checked")=="checked";
          param["agari"][name] = val;
        });
        //dbgmsg(print_r(param));

        //is_parentの計算
        param["agari"]["is_parent"] = param["agari"]["jikaze"]=="ton";

        //JSONに変換
        var json = toJSON(param);
        dbgmsg("<h4>SEND:</h4>" + json);

        //リクエスト送信
        $.ajax({
          type: "POST",
          url: url,
          data: json,
          success: function(data, textStatus, xhr) {
            infomsg("success to send . " + xhr.status );
            dbgmsg("<h4>RESPONSE:</h4>" + toJSON(data));

            $("#resultdiv").html(agariToHtml(data.agari));
          },
          error: function(data) {
            infomsg("fail to send ! " + data.status);
            dbgmsg(data.responseText);
          }
        });
      }

      function imgload() {
        $("#image").attr("src",$('#img_url').val());
      }

      function infomsg(msg) {
        $("#infodiv").html(msg);
      }

      function dbgmsg(msg) {
        $("#dbgdiv").append("<hr>" + msg) ;
      }

      function agariToHtml(a) {

        var manganStr="";
        switch (a.mangan_scale) {
          case 0:
            manganStr="" ;
            break;
          case 1:
            manganStr="満貫 " ;
            break;
          case 1.5:
            manganStr="跳満 " ;
            break;
          case 2:
            manganStr="倍満 " ;
            break;
          case 3:
            manganStr="三倍満 " ;
            break;
          case 4:
            manganStr="役満 " ;
            break;
          case 8:
            manganStr="ダブル役満 " ;
            break;
          case 12:
            manganStr="トリプル役満 " ;
            break;
          case 16:
            manganStr="四倍役満 " ;
            break;
        }

        //HTML生成
        var html ="<h3>解析結果</h3>";

        html += "<p>"
        for(var i=0;i<28;i+=2) {
          var paistr = a.tehai_list.slice(i,i+2);
          if(paistr == ""){
           //解析に失敗したパイがある場合
            paistr = "z0";//失敗画像のファイル名"z0"を指定
          }
          html += "<img width=17 src=img/" + paistr + ".gif>";
        }

        html += "</p>"

        html += "<table>";
        $.each(a.yaku_list, function() {
          html += "<tr><td>" + this.name_kanji + "</td><td>" + this.han_num +"飜</td></tr>";
        });
        html +="</table>";

        html += "<p>" + a.total_fu_num + "符　" + manganStr + a.total_han_num + "飜　" + a.total_point + "点</p>"

        if(a.is_parent) {
          html += a.child_point + "点　オール"
        } else {
          html += "子"+a.child_point + "点/親" +a.parent_point + "点"
        }
        return html;
      };
    </script>
  </head>

  <body onload="onLoad()">
    <h2>Mj-Tsumotter</h2>
    <div style="border:1px solid gray; width:250px;" id="infodiv">
      let's take mj agari photo
    </div>

    <form name="agari">
      <table>
        <tr>
          <td colspan=2>
          <button onclick="capturePhoto();">
            Capture Photo
          </button>
          </td>
          <td colspan=2>
          <button onclick="selectPhoto();">
            Select Photo
          </button>
          </td>
        </tr>
        <tr>
          <td colspan=4> 画像URL</td>
        </tr>
        <tr>
          <td colspan=4>
          <input id="img_url" type="text" name="img_url" size="40" onchange="imgload">
          </td>
        </tr>
        <tr>
          <td colspan=4>
          <img id="image" width="200" height="200" src="img/nophoto.jpg"/>
          </td>
        </tr>

        <br/>
        <tr>
          <td> 場風</td>
          <td>
          <select name="bakaze">
            <option value="ton">東</option>
            <option value="nan">南</option>
            <option value="sha">西</option>
            <option value="pei">北</option>
          </select>
          </td>
          <td> 自風</td>
          <td>
          <select name="jikaze">
            <option value="ton">東</option>
            <option value="nan">南</option>
            <option value="sha">西</option>
            <option value="pei">北</option>
          </select>
          </td>
        </tr>
        <tr>
          <td> 本場</td>
          <td>
          <select name="honba_num">
            <script type="text/javascript" charset="utf-8">
              for(i=0;i<10;i++) {
                document.write("<option value=" + i + ">" + i + " </option>");
              }
            </script>
          </select>
          </td>
          <td> アガリ</td>
          <td>
          <select name="is_tsumo">
            <option value="true">ツモ</option>
            <option value="false">ロン</option>
          </select>
          </td>
        </tr>
        <tr>
          <td> ドラ</td>
          <td>
          <select name="dora_num">
            <script type="text/javascript" charset="utf-8">
              for(i=0;i<30;i++) {
                document.write("<option value=" + i + ">" + i + " </option>");
              }
            </script>
          </select>
          </td>
          <td> リーチ</td>
          <td>
          <select name="reach_num">
            <option value="0">なし</option>
            <option value="1">ノーマル</option>
            <option value="2">ダブリー</option>
          </select>
          </td>
        </tr>
        <tr>
          <td> 一発</td>
          <td>

          <input type="checkbox" name="is_ippatsu" value="true">
          </td>
          <td> 海底</td>
          <td>
          <input type="checkbox" name="is_haitei" value="true">
          </td>
        </tr>
        <tr>
          <td> 嶺上</td>
          <td>
          <input type="checkbox" name="is_rinshan" value="true">
          </td>
          <td> 槍槓</td>
          <td>
          <input type="checkbox" name="is_chankan" value="true">
          </td>
        </tr>
        <tr>
          <td> 天和</td>
          <td>
          <input type="checkbox" name="is_tenho" value="true">
          </td>
          <td> 地和</td>
          <td>
          <input type="checkbox" name="is_chiho" value="true">
          </td>
        </tr>
      </table>
    </form>

    <button style="width: 200px;" onclick="sendPhoto();">
      Send Data
    </button>

    <div id="resultdiv">
    </div>

    <hr>
    <h3>debug message</h3>

    <label type="text" id="dbgdiv">
    </label>
  </body>
</html>

